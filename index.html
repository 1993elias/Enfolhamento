<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enfolhamento - Classificador de Imagens</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.22.0/tf.min.js"></script>
    <!-- ADIÇÃO: Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ... teu CSS original ... */

        /* ADIÇÃO: ajustar canvas */
        #histogram-container {
            margin-top: 25px;
            background: #fff;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        #histogram {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ... teu HTML original ... -->

        <div class="results-container" id="results-container">
            <div id="main-result"></div>
            <h3 style="color: #4a5568; margin-bottom: 20px; text-align: center;">📊 Detalhes da Classificação</h3>
            <div id="results"></div>

            <!-- ADIÇÃO: histograma -->
            <div id="histogram-container">
                <h4 style="color:#4a5568; text-align:center; margin-bottom:10px;">🌈 Histograma de Hue (11 bins)</h4>
                <canvas id="histogram"></canvas>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Classificador baseado em CNN • TensorFlow.js</p>
    </div>

    <script>
        let model = null;
        let currentImage = null;
        let histogramChart = null; // ADIÇÃO

        const classNames = ['Alto_enfolhamento', 'Baixo_enfolhamento', 'Medio_enfolhamento'];

        const MODEL_URLS = [
            'https://raw.githubusercontent.com/1993elias/Enfolhamento/main/modelo.json'
        ];

        // Paleta viridis (11 bins fixos) - ADIÇÃO
        const viridis11 = [
            "#440154", "#472c7a", "#3b518b", "#2c718e", "#21908d",
            "#27ad81", "#5cc863", "#aadc32", "#fde725", "#d4e21a", "#7ad151"
        ];

        // ... todo teu código original até displayResults() ...

        function displayResults(predictions) {
            // ... teu código original de resultados ...

            resultsDiv.innerHTML = resultsHTML;
            resultsContainer.style.display = 'block';

            // Scroll suave para os resultados
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // ADIÇÃO: gerar histograma
            generateHueHistogram();
        }

        // ADIÇÃO: calcular histograma de Hue
        function generateHueHistogram() {
            if (!currentImage) return;

            const img = new Image();
            img.src = currentImage;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, img.width, img.height).data;

                // 11 bins
                const bins = new Array(11).fill(0);

                for (let i = 0; i < imageData.length; i += 4) {
                    const r = imageData[i] / 255;
                    const g = imageData[i+1] / 255;
                    const b = imageData[i+2] / 255;

                    const max = Math.max(r,g,b);
                    const min = Math.min(r,g,b);
                    let h = 0;
                    if (max !== min) {
                        if (max === r) h = (60 * ((g-b)/(max-min)) + 360) % 360;
                        else if (max === g) h = (60 * ((b-r)/(max-min)) + 120) % 360;
                        else h = (60 * ((r-g)/(max-min)) + 240) % 360;
                    }

                    const bin = Math.floor(h / (360/11));
                    bins[bin]++;
                }

                // Normalizar
                const total = bins.reduce((a,b)=>a+b,0);
                const percentages = bins.map(v => (v/total*100).toFixed(2));

                // Plotar
                const ctxHist = document.getElementById('histogram').getContext('2d');
                if (histogramChart) histogramChart.destroy();
                histogramChart = new Chart(ctxHist, {
                    type: 'bar',
                    data: {
                        labels: bins.map((_,i)=>`Bin ${i+1}`),
                        datasets: [{
                            data: percentages,
                            backgroundColor: viridis11,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: ctx => ctx.raw + "%" } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display:true, text:"%" }
                            },
                            x: {
                                title: { display:true, text:"Bins (Hue)" }
                            }
                        }
                    }
                });
            };
        }

        // ... resto do teu código original (resetInterface, loadModel etc.) ...
        window.addEventListener('load', loadModel);
        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('drop', e => e.preventDefault());
    </script>
</body>
</html>
